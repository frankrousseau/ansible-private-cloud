---
# file: tasks/main.yml

- include: Debian.yml
  when: ansible_os_family == "Debian"

- name: Setup CouchDB user
  user: name=couchdb home=/var/lib/couchdb

- name: Add CouchDB mandatory directories
  file: path={{ item }} state=directory owner=couchdb group=couchdb mode=0775
  with_items:
    - /usr/local/etc/couchdb
    - /usr/local/lib/couchdb
    - /usr/local/var/lib/couchdb
    - /usr/local/var/log/couchdb
    - /usr/local/var/run/couchdb

#- name: Checking installed version of nodejs
  #shell: /usr/bin/test "$({{nodejs_path}}bin/node -v 2> /dev/null)" = {{nodejs_version_tag}}
  #register: wanted_version_installed
  #ignore_errors: True
  #changed_when: "wanted_version_installed.rc == 1"

- name: Download CouchDB 1.5
  get_url: url={{nodejs_tarball_url}} dest={{nodejs_tmp_dir}}{{nodejs_file_name}}
  when: wanted_version_installed.rc == 1

- name: Verify SHASUM of nodejs {{nodejs_version_tag}}
  shell: curl {{nodejs_shasum_url}} | grep {{nodejs_file_name}} | sha1sum -c chdir={{nodejs_tmp_dir}}
  when: wanted_version_installed.rc == 1

- name: Unpack nodejs {{nodejs_version_tag}}
  command: tar -xvzf {{nodejs_file_name}} chdir={{nodejs_tmp_dir}}
  when: wanted_version_installed.rc == 1

- name: Compile and install nodejs {{nodejs_version_tag}}
  shell: ./configure --prefix={{nodejs_path}} && make && make install chdir={{nodejs_tmp_dir}}{{nodejs_file_tag}}
  sudo: true
  when: wanted_version_installed.rc == 1

- name: NPM Install global packages
  npm: name={{item}} global=yes
  with_items: nodejs_global_packages
#tar xzf apache-couchdb-*.tar.gz
#cd apache-couchdb-*
#./configure --prefix=/usr/local --with-js-lib=/usr/lib --with-js-include=/usr/include/mozjs --enable-init
#make && sudo make install

#sudo ln -s /usr/local/etc/init.d/couchdb /etc/init.d/couchdb
#sudo /etc/init.d/couchdb start
#sudo update-rc.d couchdb defaults
## check it runs
#curl http://127.0.0.1:5984/
